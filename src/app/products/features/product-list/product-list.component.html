<h1 class="text-center">Liste des produits</h1>

<div class="filters-section mb-4">
    <div class="flex flex-wrap gap-3 align-items-center justify-content-between">
        <div class="flex gap-3 flex-1">
            <span class="p-input-icon-left flex-1" style="max-width: 400px;">
                <i class="pi pi-search"></i>
                <input pInputText type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)"
                    placeholder="Rechercher par nom, catégorie ou prix..." class="w-full" />
            </span>

            <p-dropdown [options]="categoryOptions()" [ngModel]="selectedCategory()"
                (ngModelChange)="selectedCategory.set($event)" placeholder="Toutes les catégories" [showClear]="true"
                styleClass="w-full" [style]="{'min-width': '200px'}">
            </p-dropdown>

            <p-dropdown [options]="statusOptions" [ngModel]="selectedStatus()"
                (ngModelChange)="selectedStatus.set($event)" placeholder="Tous les statuts" [showClear]="true"
                styleClass="w-full" [style]="{'min-width': '200px'}">
            </p-dropdown>

            <p-button icon="pi pi-filter-slash" label="Réinitialiser" severity="secondary" [outlined]="true"
                (onClick)="resetFilters()">
            </p-button>
        </div>

        <p-button label="Créer produit" icon="pi pi-plus" (onClick)="onCreate()" />
    </div>

    <div class="mt-3 text-sm text-color-secondary">
        {{ totalRecords() }} produit(s) trouvé(s)
    </div>
</div>

<p-dataView #dv [value]="filteredProducts()" [rows]="rowsPerPage()" [paginator]="true"
    [first]="currentPage() * rowsPerPage()" (onPage)="onPageChange($event)" [rowsPerPageOptions]="[5, 10, 20, 50]">

    <ng-template pTemplate="list" let-products>
        @for (product of products; track product) {
        <p-card class="block mb-2">
            <div class="flex gap-2 items-center">
                <div class="w-16 h-16 flex-shrink-0 p-0.5">
                    <img [src]="product.image ? 'assets/' + product.image : 'assets/no-image.svg'"
                        alt="{{ product.name }} " class="w-full h-full object-cover rounded shadow-sm"
                        (error)="onImgError($event)" />
                </div>
                <div class="flex-1">
                    <div class="border-1 border-round-lg surface-ground p-3">
                        <!-- Première ligne -->
                        <div class="mb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-base px-5 font-medium text-900">{{ product.name }}</span>
                                <span class="text-lg font-semibold text-900">{{ product.price | formatPrice }}</span>
                            </div>
                        </div>

                        <!-- Deuxième ligne -->
                        <div>
                            <div class="flex justify-between items-center">
                                <span class="px-5"
                                    [style.backgroundColor]="product.inventoryStatus === 'INSTOCK' ? '#ECFDF5' : (product.inventoryStatus === 'LOWSTOCK' ? '#FFF7ED' : (product.inventoryStatus === 'OUTOFSTOCK' ? '#FEE2E2' : 'transparent'))"
                                    [style.color]="product.inventoryStatus === 'INSTOCK' ? '#065F46' : (product.inventoryStatus === 'LOWSTOCK' ? '#92400E' : (product.inventoryStatus === 'OUTOFSTOCK' ? '#7F1D1D' : '#374151'))"
                                    style=" border-radius:9999px; font-weight:600; font-size:0.9rem; display:inline-block;">
                                    {{ product.inventoryStatus === 'INSTOCK' ? 'EN STOCK' : (product.inventoryStatus ===
                                    'LOWSTOCK' ? 'STOCK BAS' : (product.inventoryStatus === 'OUTOFSTOCK' ? 'RUPTURE' :
                                    product.inventoryStatus)) }}
                                </span>
                                @if (product.rating !== undefined && product.rating !== null) {
                                <span class="text-sm text-600">Rating: {{ product.rating }}/5</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <ng-template pTemplate="footer">
                <div class="flex gap-3 -mt-2 justify-content-center">
                    <p-button label="Modifier" severity="secondary" (onClick)="onUpdate(product)"
                        [style]="{'height': '2rem'}" />
                    <p-button label="Supprimer" severity="danger" (onClick)="onDelete(product)"
                        [style]="{'height': '2rem'}" />
                    @if (!isInCart(product.id)) {
                    <p-button label="Ajouter au panier" severity="success" (onClick)="onAddToCart(product)"
                        [style]="{'height': '2rem'}" />
                    } @else {
                    <p-button label="Retirer du panier" severity="warning" (onClick)="onRemoveFromCart(product.id)"
                        [style]="{'height': '2rem'}" />
                    }
                </div>
            </ng-template>
        </p-card>
        }
    </ng-template>
</p-dataView>

<p-dialog [(visible)]="isDialogVisible" [style]="{ width: '50vw' }" header="Ajout/Edition produit">
    <app-product-form [product]="editedProduct()" (save)="onSave($event)" (cancel)="onCancel()" />
</p-dialog>